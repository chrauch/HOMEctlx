This file is part of HOMEctlx. Copyright (C) 2024 Christian Rauch. 
Distributed under terms of the GPL3 license.

# Installation

## Create a virtual environment
Copy application files to a place like /srv and change into the directory.
  cd /srv/homectlx
Requires Python, pip, python3-venv.
Create the virtual environment.
  python3 -m venv .venv
Activate it.
  source .venv/bin/activate
Install Flask and WSGI components.
  python3 -m pip install -r ./etc/requirements.txt
Environments are not portable, create them in place.

## Install, configure, and run Gunicorn
Note: HOMEctlx uses Flask-SocketIO for WebSocket communication. Gunicorn with gevent 
worker is required because uWSGI does not support WebSocket protocol upgrades properly.
The WebSocket protocol requires special HTTP Upgrade headers that uWSGI cannot handle,
causing connection failures (wss:// errors) when deployed behind Nginx with HTTPS.

Gunicorn and gevent are already included in requirements.txt and should be installed.
Verify installation:
  source .venv/bin/activate
  pip list | grep -E "gunicorn|gevent"

Test the application server:
  cd /srv/homectlx
  source .venv/bin/activate
  gunicorn --config ./etc/homectlx_gunicorn.py app:app

Open http://localhost:5010 in a browser and check if it works.
Press Ctrl+C to stop the test server.
Note: After Nginx is configured, access will be via https://localhost (or your server IP).

Configure Gunicorn as a systemd service:
  sudo cp /srv/homectlx/etc/homectlx.service /etc/systemd/system/

Adjust the service file if needed (user, paths):
  sudo nano /etc/systemd/system/homectlx.service
  
Key settings to verify:
  User=chris              (change to your username)
  WorkingDirectory=/srv/homectlx
  Environment="PATH=/srv/homectlx/.venv/bin"
  ExecStart=/srv/homectlx/.venv/bin/gunicorn --config /srv/homectlx/etc/homectlx_gunicorn.py app:app

The Gunicorn configuration file is at ./etc/homectlx_gunicorn.py
You may adjust settings like worker_connections or logging paths:
  nano /srv/homectlx/etc/homectlx_gunicorn.py

Reload systemd and enable the service:
  sudo systemctl daemon-reload
  sudo systemctl enable homectlx
  sudo systemctl start homectlx

Check service status:
  sudo systemctl status homectlx

View logs:
  sudo journalctl -u homectlx -f

## Generate self-signed SSL certificate for HTTPS
Since this application runs on a local network only, create a self-signed certificate.
Create a directory for SSL certificates.
  sudo mkdir -p /etc/ssl/homectlx

Generate a self-signed certificate with no expiration date.
  sudo openssl req -x509 -nodes -days 36500 -newkey rsa:2048 \
    -keyout /etc/ssl/homectlx/server.key \
    -out /etc/ssl/homectlx/server.crt

When prompted, fill in the certificate information:
  - Country Name: Your country code (e.g., DE)
  - State or Province: Your state
  - Locality Name: Your city
  - Organization Name: Your organization or "Home Network"
  - Common Name: Your server's IP address (e.g., 192.168.0.100) or hostname
  - Email Address: Your email (optional)

Set appropriate permissions for the certificate files.
  sudo chmod 600 /etc/ssl/homectlx/server.key
  sudo chmod 644 /etc/ssl/homectlx/server.crt

Note: Browsers will show a security warning for self-signed certificates.
You will need to add a security exception in your browser to access the site.
s
## Install, configure, and run the web-server
Install Nginx using the package manager of your system.
  sudo [apt-get|dnf|...] install nginx

Configure the reverse proxy for HTTPS-only access with WebSocket support.
Copy the provided configuration:
  sudo cp /srv/homectlx/etc/nginx-websocket.conf /etc/nginx/sites-available/homectlx

You might need to remove the default configuration if conflicting.
  sudo rm /etc/nginx/sites-enabled/default
  
Add to enabled sites:
  sudo ln -s /etc/nginx/sites-available/homectlx /etc/nginx/sites-enabled/default

Change the maximum body size to allow the upload of big files.
  sudo nano /etc/nginx/nginx.conf
  http {
    ...
    client_max_body_size 10G;
    ...
  }

Test the configuration.
  sudo nginx -t

Enable and (re)start.
  sudo systemctl enable nginx
  sudo systemctl reload nginx

## Enable lightctl
Make the lightctl test scripts executable.
  chmod +x ./external/lightctl-test.sh
Change the config.json accordingly to use lightctl:
Bridge address and user name have to be set. 
See lightctl --help.

## File sharing
Files in the share directory (/srv/homectlx/share) are shared with everyone who has access to the applicaton. You should enable write protection for essential files.
  chmod -R a-w /srv/homectlx/share/<protected directory>
You may want to verify the permission change.
  ls -lR /srv/homectlx/share/<protected directory>
The share directory can be changed in config.json.

## Setup authentication
HOMEctlx requires user authentication to access the application.
After completing the installation, you must create at least one user account.

The management script supports the following commands:
  python etc/manage_users.py add <username> <password>         - Add a new user
  python etc/manage_users.py delete <username>                 - Delete an existing user
  python etc/manage_users.py list                              - List all users
  python etc/manage_users.py changepw <username> <newpassword> - Change the password for a user
